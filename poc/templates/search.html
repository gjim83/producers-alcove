<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <title>Shortcut Search</title>
    <style>
        form {
            text-align: center;
        }
        table {
            border-collapse: collapse;
            width: 50%;
            margin: 20px auto;
        }

        tbody tr:nth-child(odd) {
          background-color: #fffaf0;
          color: #000;
        }

        tbody tr:nth-child(even) {
          background-color: #dcdcdc;
          color: #000;
        }

        th {
            background-color: black;
            color: #dddddd;
        }
    </style>
</head>
    <body>
        <form>
            <input id="searchtext" type="text" placeholder="Type text to search in description">
            <input id="searchelems" type="text" placeholder="Press shortcut keys">
            <input type="reset" id="searchreset" value="Reset Search">
        </form>
        <p></p>
        <div id="searchDisplay" align="center">
            <div>Current search keys: </div><div id="searchDisplayString"></div>
        </div>
        <table>
            <tr>
                <th>Description</th>
                <th>Mac</th>
                <th>Windows</th>
            </tr>
            <tbody id="sctable">
            {%- for sc in shortcuts %}
                {%- set display_sc = {'mac': '', 'windows': ''} %}
                {%- for _os in display_sc.keys() %}
                    {%- set modkey_str = ' + '.join(sc[_os].get('mod', [])) %}
                    {%- set char_str = ' or '.join(sc[_os].get('chars', [])) %}
                    {%- if modkey_str and char_str %}
                        {%- set _ = display_sc.__setitem__(_os, ' + '.join([modkey_str, char_str])) %}
                    {%- else %}
                        {%- set _ = display_sc.__setitem__(_os, ''.join([modkey_str, char_str])) %}
                    {%- endif %}
                {%- endfor %}
                <tr>
                    <td>{{ sc['description'] }}</td>
                    <td>{{ display_sc['mac'] }}</td>
                    <td>{{ display_sc['windows'] }}</td>
                </tr>
            {%- endfor %}
            </tbody>
        </table>
    </body>

    <br>

    <script>
        const modKeyMap = JSON.parse('{{ mod_key_map|tojson }}');
        let scIndexData = [];
        fetch('{{ url_for("sc_index") }}')
        .then((response) => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then((data) => {
            /* scIndexData structure: [
                  [character, [indices in table where the character is part of the shortcut]],
                  [string representation of modifier key, [indices in table where the key is part of the shortcut]],
                  ...,
              ]
             character: a "typeable" character: letter, comma, number, etc...
             modifier key: control, shift, Esc, etc... */
            scIndexData = Object.entries(data.mac); // TODO: hardcoded for Mac, add filter by windows
        })
        .catch(error => console.error('Failed to fetch data:', error));

        let displayElemIndex = 0;
        let show = true;
        let scDescription = '';
        let searchElemsUnique = [];
        $(document).ready(function () {
            $("#searchelems").on("keyup", function (event) {
                let nonCharKey = '';
                //console.log('keycode pressed')
                //console.log(event.keyCode)
                let rowsToShow = []
                // let selectedColumn = $("#columnSelect").val();  // TODO filter display/search by OS
                let searchText = $.trim($("#searchtext").val()).toLowerCase()
                let searchElems = $("#searchelems").val().toLowerCase().split("")
                switch (event.keyCode) {
                    {%- for key, data in mod_key_map['mac'].items() %}
                    case {{ data['keycode'] }}:
                        nonCharKey = '{{ key }}';
                        break;
                    {%- endfor %}
                }
                searchElemsUnique.push(...searchElems);
                if (nonCharKey.length !== 0) {
                    searchElemsUnique.push(nonCharKey)
                }

                searchElemsUnique = Array.from(new Set(searchElemsUnique));

                let searchDisplayElems = searchElemsUnique.map((el) =>
                    el in modKeyMap.mac ? modKeyMap.mac[el].ui_char : el.toUpperCase()
                );

                $("#searchDisplayString").text(searchDisplayElems.join(" "));

                let rowsToShowInit = false;
                let shouldBreak = false;
                let searchElemFound = false;
                for (let iSE in searchElemsUnique) {
                    searchElemFound = false;
                    for (let iIE in scIndexData) {
                        if (searchElemsUnique[iSE] !== scIndexData[iIE][0]) continue;
                        searchElemFound = true;
                        if (!rowsToShowInit) {
                            rowsToShow = scIndexData[iIE][1];
                            rowsToShowInit = true;
                            continue; // skip filter if it's the first match
                        }
                        rowsToShow = rowsToShow.filter((el) => scIndexData[iIE][1].includes(el))
                        if (rowsToShow.length === 0 && rowsToShowInit) {
                            // just stop if the current search combination is already returning no results
                            shouldBreak = true;
                            break
                        }
                    }
                    if (!searchElemFound) {
                        /* if the current search element was not found in db then by definition
                           the combination can't match any commands */
                        rowsToShow = [];
                        break;
                    }
                    if (shouldBreak) {
                        break
                    }
                }

                displayElemIndex = 0;
                $("#sctable tr").each(function (index) {
                    show = rowsToShow.includes(index) || searchElemsUnique.length === 0;
                    if (searchText) {
                        /* TODO: consider making full sc structured data available to previous
                                 function and filter this there instead of parsing HTML values */
                        scDescription = $(this).find("td:first").html().toLowerCase()
                        show = show && scDescription.indexOf(searchText) !== -1;
                    }
                    $(this).toggle(show);
                    if (!show) { return };
                    /* this should be done by setting the class instead of directly
                       updating CSS but couldn't get it to work properly */
                    if (displayElemIndex % 2 === 0) {
                        $(this).css('background-color', '#dcdcdc');
                    } else {
                        $(this).css('background-color', '#fffaf0');
                    };
                    displayElemIndex++;
                });
            });


            $("#searchreset").click(function () {
                searchElemsUnique = [];
                $("#searchDisplayString").text("");
                $("#sctable tr").each(function (index) {
                    $(this).toggle(true);
                    if (index % 2 === 0) {
                        $(this).css('background-color', '#dcdcdc');
                    } else {
                        $(this).css('background-color', '#fffaf0');
                    };
                });
            });
        })
    </script>
</html>