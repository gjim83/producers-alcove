<!DOCTYPE html>
<html lang="en">
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="{{ url_for('static', filename='js/main.js') }}"></script>
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">
        <title>producer's alcove_ : {{ page_data.display }}</title>
        <style>
            form {
                text-align: center;
                position: relative;
                top: 0px;
            }
            table {
                border-collapse: collapse;
                border-style: hidden;
                color: {{ page_data.css.font_color_dark }};
                width: 80%;
                margin: 20px auto;
                top: 180px;
                position: relative;
                font-size: 20px;
                text-align: left;
            }

            th {
                border-bottom: 2px solid {{ page_data.css.font_color_dark }};
                text-align: left;
                font-size: 24px;
            }

            tbody tr {
                border-bottom: 2px solid {{ page_data.css.font_color_dark }};
            }

            .no-results-message {
                top: 180px;
                position: relative;
                font-size: 24px;
                color: {{ page_data.css.font_color_dark }};
                text-align: center;
                display: none;
            }

            #searchDisplay {
                display: none;
            }

            .input-shortcut-search {
                top: 40px;
                width: 250px;
                left: calc(50% - 120px);
                font-size: 24px;
            }

            .input-key-search {
                top: 86px;
                width: 200px;
                right: calc(50% - 38px);
                font-size: 24px;
            }

            .reset-key-search-button {
                position: absolute;
                top: 92px;
                left: calc(50% + 42px);
                padding: 2px 8px;
                margin: 0px;
                font-size: 16px;
                width: 130px;
            }

            .reset-full-search-button {
                position: absolute;
                top: 140px;
                padding: 2px 8px;
                margin: 0px;
                font-size: 16px;
                width: 130px;
                left: calc(50% - 65px);
            }

            .current-search-container {
                position: relative;
                top: 164px;
                font-size: 24px;
            }

            /* easter egg */
            .popup {
                width: 100%;
                left: 0px;
                text-align: center;
                position: absolute;
                display: inline-block;
                cursor: pointer;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            /* The actual popup */
            .popup .easterEgg {
              visibility: hidden;
              width: 500px;
              background-color: #555;
              color: #fff;
              text-align: center;
              border-radius: 6px;
              padding: 8px 0;
              position: absolute;
              z-index: 1;
              top: 30px;
              left: 50%;
              margin-left: -80px;
            }

            /* Toggle this class - hide and show the popup */
            .popup .show {
              visibility: visible;
              -webkit-animation: fadeIn 1s;
              animation: fadeIn 1s;
            }

            /* Add animation (fade in the popup) */
            @-webkit-keyframes fadeIn {
              from {opacity: 0;}
              to {opacity: 1;}
            }

            @keyframes fadeIn {
              from {opacity: 0;}
              to {opacity:1 ;}
            }

            /* help message */
            .help-container {
                width: 80px;
                left: calc(50% - 40px);
                position: relative;
                text-align: center;
                color: {{ page_data.css.font_color }};
                font-size: 20px;
                display: flex;
                justify-content: center;
                z-index: 10;
            }

            .help-content {
                display: none;
                position: absolute;
                background-color: {{ page_data.css.bg_color }};
                top: 0px;
                width: 550px;
                min-width: 130px;
                box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
                padding: 12px 16px;
                align-self: center;
            }

            .help-container:hover .help-content {
                display: block;
            }
        </style>
    </head>
    <body>
        <div class="page-container">
            {%- from "page_header.j2" import page_header as ph %}
            {{ ph(page_data) }}
            <div class="main-content">
                <div class="help-container">â“˜ help
                    <div class="help-content">
                    <p>thanks for trying out our protools shortcut search engine!</p>

                    <p>- use the 'search by shortcut description' field to filter shortcuts by<br>
                        text. for example: 'selection', 'nudge' or 'trim'. use your backspace key<br>
                        to fix typos in this field as you would in any other search
                    </p>

                    <p>- use the 'search by shortcut keys' field to filter shortcuts by<br>
                        the actual keys you press. for example: shift, command or the letter 'p'<br>
                        use the 'reset key search' instead of backspace in this one.<br>
                        hint: you can press several and we'll show the shortcuts<br>
                        that contain all the ones you pressed
                    </p>

                    <p>- you can use any combination of these two. try it out!</p>

                    <p>__________________</p>

                    <p>as this is a proof of concept, there's some bugs/limitations that<br>
                    we're still working out:</p>

                    <p>- 'backspace' is a key used in shortcuts, so deleting individual<br>
                    characters from the shortcut key search doesn't reset the search.<br>
                    please use 'reset key search' button in the mean time. we'll make this better soon</p>

                    <p>- the 'tab' button actually needs to be pressed in the shortcut description<br>
                    to get picked up by the search engine. weird, we know :( we're working on it</p>

                    <p>- this is obviously a small subset of protools shortcuts. hang tight! we'll<br>
                    keep adding more all the time</p>
                    </div>
                </div>
                <form style="text-align: center;">
                    <div>
                        <input id="searchtext" type="text" class="input-field input-shortcut-search" placeholder="search by shortcut description...">
                    </div>
                    <div>
                        <input id="searchelems" type="text" class="input-field input-key-search" placeholder="search by shortcut keys...">
                        <input type="button" id="searchkeyreset" class="button reset-key-search-button" value="reset key search">
                    </div>
                    <div>
                        <input type="reset" id="fullreset" class="button reset-full-search-button" value="reset full search">
                    </div>
                </form>
                <p></p>
                <div id="searchDisplay" align="center" class="current-search-container">
                    <div>current search keys:</div>
                    <div id="searchDisplayString"></div>
                </div>
                <div id="no-results-div" class="no-results-message">I don't know any shortcuts that match your search :'( sorry...</div>
                <table id="outer-sctable">
                    <tr>
                        <th>shortcut description</th>
                        <th>mac</th>
                        <th>windows</th>
                    </tr>
                    <tbody id="sctable">
                    {%- for sc in shortcuts %}
                        {%- set display_sc = {'mac': '', 'windows': ''} %}
                        {%- for _os in display_sc.keys() %}
                            {%- set modkey_str = ' <small>+</small> '.join(sc[_os].get('mod', [])) %}
                            {%- set char_str = ' or '.join(sc[_os].get('chars', [])) %}
                            {%- if modkey_str and char_str %}
                                {%- set _ = display_sc.__setitem__(_os, ' <small>+</small> '.join([modkey_str, char_str]))|safe %}
                            {%- else %}
                                {%- set _ = display_sc.__setitem__(_os, ''.join([modkey_str, char_str])) %}
                            {%- endif %}
                        {%- endfor %}
                        <tr>
                            <td>{{ sc['description'] }}</td>
                            <td>{{ display_sc['mac']|safe }}</td>
                            <td>{{ display_sc['windows']|safe }}</td>
                        </tr>
                    {%- endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </body>

    <script>
        getIP();
        const modKeyMap = JSON.parse('{{ mod_key_map|tojson }}');
        let scIndexData = [];
        fetch('{{ url_for("sc_index") }}')
        .then((response) => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then((data) => {
            /* scIndexData structure: [
                  [character, [indices in table where the character is part of the shortcut]],
                  [string representation of modifier key, [indices in table where the key is part of the shortcut]],
                  ...,
              ]
             character: a "typeable" character: letter, comma, number, etc...
             modifier key: control, shift, Esc, etc... */
            scIndexData = Object.entries(data.mac); // TODO: hardcoded for Mac, add filter by windows
        })
        .catch(error => console.error('Failed to fetch data:', error));

        let show = true;
        let scDescription = '';
        let searchElemsUnique = [];
        let searchText =  '';
        let rowsToShowKeys = [];  // rows to show if user has searched for shortcut keys
        let rowsToShowText = [];  // rows to show if user has searched for shortcut description

        $(document).ready(function () {
           function toggleNoResultsMessage(showNoResults) {
                if (showNoResults) {
                    $("#no-results-div").toggle(true);
                    $("#outer-sctable").toggle(false);
                } else {
                    $("#no-results-div").toggle(false);
                    $("#outer-sctable").toggle(true);
                };
            }

            $("#searchtext").on("keyup", function () {
                rowsToShowText = [];
                searchText = $.trim($("#searchtext").val()).toLowerCase()

                $("#sctable tr").each(function (index) {
                    let allowedByKeySearch = true;
                    if (searchElemsUnique.length > 0) {
                        allowedByKeySearch = rowsToShowKeys.indexOf(index) !== -1;
                    }
                    scDescription = $(this).find("td:first").html().toLowerCase()
                    show = allowedByKeySearch && scDescription.indexOf(searchText) !== -1;
                    $(this).toggle(show);
                    if (!show) { return };
                    rowsToShowText.push(index)
                });
                toggleNoResultsMessage(rowsToShowText.length === 0);
            });

            $("#searchelems").on("keyup", function (event) {
                $("#searchDisplay").toggle(true);
                rowsToShowKeys = [];
                let nonCharKey = '';
                //console.log('keycode pressed')
                //console.log(event.keyCode)
                // let selectedColumn = $("#columnSelect").val();  // TODO filter display/search by OS
                let searchElems = $("#searchelems").val().toLowerCase().split("")

                // display search in upper case
                $("#searchelems").val($("#searchelems").val().toUpperCase())

                switch (event.keyCode) {
                    {%- for key, data in mod_key_map['mac'].items() %}
                        {%- for code in data['keycode'] %}
                    case {{ code }}:
                        nonCharKey = '{{ key }}';
                        break;
                        {%- endfor %}
                    {%- endfor %}
                }
                searchElemsUnique.push(...searchElems);
                if (nonCharKey.length !== 0) {
                    searchElemsUnique.push(nonCharKey)
                }

                searchElemsUnique = Array.from(new Set(searchElemsUnique));

                let searchDisplayElems = searchElemsUnique.map((el) =>
                    el in modKeyMap.mac ? modKeyMap.mac[el].ui_char : el.toUpperCase()
                );

                $("#searchDisplayString").text(searchDisplayElems.join(" "));

                let rowsToShowInit = false;
                let noResults = false;
                let searchElemFound = false;
                for (let iSE in searchElemsUnique) {
                    searchElemFound = false;
                    for (let iIE in scIndexData) {
                        if (searchElemsUnique[iSE] !== scIndexData[iIE][0]) continue;
                        searchElemFound = true;
                        if (!rowsToShowInit) {
                            rowsToShowKeys = scIndexData[iIE][1];
                            rowsToShowInit = true;
                            continue; // skip filter if it's the first match
                        }
                        rowsToShowKeys = rowsToShowKeys.filter((el) => scIndexData[iIE][1].includes(el))
                        if (rowsToShowKeys.length === 0 && rowsToShowInit) {
                            // just stop if the current search combination is already returning no results
                            noResults = true;
                            break
                        }
                    }
                    if (!searchElemFound) {
                        /* if the current search element was not found in db then by definition
                           the combination can't match any commands */
                        rowsToShowKeys = [];
                        break;
                    }
                    if (noResults) {
                        break
                    }
                }
                toggleNoResultsMessage(rowsToShowKeys.length === 0);
                if (!noResults) {
                    let combinedShown = false;
                    $("#sctable tr").each(function (index) {
                        let allowedByTextSearch = true;
                        if (searchText.length > 0) {
                            allowedByTextSearch = rowsToShowText.indexOf(index) !== -1;
                        }
                        show = (rowsToShowKeys.includes(index) || searchElemsUnique.length === 0) && allowedByTextSearch;
                        $(this).toggle(show);
                        if (show) {
                            combinedShown = true;
                        }
                    });
                    if (!combinedShown) {
                        toggleNoResultsMessage(true);
                    }
                };
            });

            $("#searchkeyreset").click(function () {
                searchElemsUnique = [];
                rowsToShowKeys = [];
                $("#searchDisplayString").text("");
                $("#searchelems").val("");
                $("#searchDisplay").toggle(false);
                let noResults = rowsToShowText.length === 0 && searchText.length > 0;
                toggleNoResultsMessage(noResults);
                if (!noResults) {
                    $("#sctable tr").each(function (index) {
                        show = rowsToShowText.indexOf(index) !== -1 || searchText.length === 0;
                        $(this).toggle(show);
                    });
                };
            });

            $("#fullreset").click(function () {
                toggleNoResultsMessage(false);
                searchElemsUnique = [];
                searchText = ''
                rowsToShowKeys = [];
                rowsToShowText = [];
                $("#searchDisplayString").text("");
                $("#searchDisplay").toggle(false);
                $("#sctable tr").each(function (index) {
                    $(this).toggle(true);
                });
            });
        })
    </script>
</html>